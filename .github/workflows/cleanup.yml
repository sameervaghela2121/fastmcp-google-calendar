name: Cleanup Old Deployments

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_LOCATION: australia-southeast1
  REPOSITORY: mcp-servers
  REGION: australia-southeast1

jobs:
  cleanup-images:
    runs-on: ubuntu-latest
    steps:
      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: "${{ secrets.GCP_SA_KEY }}"

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Cleanup old container images
        run: |
          # Keep only the latest 10 images for each server
          for server in google-calendar; do
            echo "Cleaning up old images for mcp-$server..."
            
            # Get all image digests sorted by creation time (oldest first)
            gcloud artifacts docker images list \
              ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/mcp-$server \
              --sort-by=CREATE_TIME \
              --format="value(digest)" \
              --limit=1000 > /tmp/${server}_images.txt
            
            # Count total images
            total_images=$(wc -l < /tmp/${server}_images.txt)
            
            if [ $total_images -gt 10 ]; then
              # Calculate how many to delete (keep latest 10)
              images_to_delete=$((total_images - 10))
              
              echo "Found $total_images images for mcp-$server, deleting oldest $images_to_delete..."
              
              # Delete oldest images
              head -n $images_to_delete /tmp/${server}_images.txt | while read digest; do
                echo "Deleting image with digest: $digest"
                gcloud artifacts docker images delete \
                  ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/mcp-$server@$digest \
                  --quiet || echo "Failed to delete image $digest"
              done
            else
              echo "Only $total_images images found for mcp-$server, no cleanup needed"
            fi
          done

      - name: Cleanup staging images
        run: |
          # Also cleanup staging images
          for server in google-calendar; do
            echo "Cleaning up staging images for mcp-$server-staging..."
            
            gcloud artifacts docker images list \
              ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/mcp-$server-staging \
              --sort-by=CREATE_TIME \
              --format="value(digest)" \
              --limit=1000 > /tmp/${server}_staging_images.txt 2>/dev/null || continue
            
            total_images=$(wc -l < /tmp/${server}_staging_images.txt)
            
            if [ $total_images -gt 5 ]; then
              images_to_delete=$((total_images - 5))
              echo "Found $total_images staging images for mcp-$server-staging, deleting oldest $images_to_delete..."
              
              head -n $images_to_delete /tmp/${server}_staging_images.txt | while read digest; do
                gcloud artifacts docker images delete \
                  ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/mcp-$server-staging@$digest \
                  --quiet || echo "Failed to delete staging image $digest"
              done
            fi
          done
